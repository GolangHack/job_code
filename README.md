# Клонирование репозитория

Перед началом работы с проектом, необходимо клонировать его на рабочий компьютер. Репозиторий с
проектом находится на [Bitbucket](https://bitbucket.org/robodinamika/tereshko/).

Для того, чтобы клонировать репозиторий, необходимо создать пару ключей SSH и добавить публичный
ключ во вкладке Access Keys в настройках репозитория проекта на Bitbucket. Процесс генерации пары
ключей описан в документации
на [Google Docs](https://docs.google.com/document/d/1LAI-NDuc52vjGR9r9EuFlVSfUonE6MhqTZmMRa3TfoI).

После добавления ключа SSH, необходимо перейти в директорию, в которой будет расположен код проекта,
и выполнить следующую команду:

`
git clone git@bitbucket.org:robodinamika/tereshko.git
`

Обратите внимание, что при клонировании проекта, подмодули проекта не клонируются вместе с ним,
вместо них просто создаются одноименные пустые директории. Процесс инициализации подмодулей
описан ниже.

# Переход на актуальную ветку Git

На момент написания данной статьи, актуальная ветка проекта называется `2.0-rc`. Перед началом
работы с проектом после его клонирования важно перейти на актуальную ветку, т.к. чаще всего она
может содержать новые подмодули, которые могут отсутствовать на других ветках.

Поэтому, необходимо уточнить название актуальной ветки и выполнить `git checkout branch.name`:

`
git checkout 2.0-rc
`

# Инициализация подмодулей проекта

Проект RobotCarWash содержит вложенные репозитории, называемые подмодулями. На данный момент, в
проекте используются следующие подмодули:

| Название       | Описание                                                            |
|----------------|---------------------------------------------------------------------|
| atol           | Взаимодействие с фискальным регистратором Казначей ФА, печать чеков |
| bankacquiring  | Проведение платежей банковскими картами                             |
| billkeeper     | Взаимодействие с оборудованием диспенсеров и аксепторов купюр       |
| cardDispenser  | Взаимодействие с оборудованием диспенсеров карт                     |
| data_storage   | Взаимодействие с базой данных терминала (MariaDB)                   |
| htmlpy_core    | Отображение экранов, взаимодействие с пользователем через дисплей   |
| lcdm1          | Взаимодействие с диспенсером купюр LCDM1                            |
| leisuwash      | Взаимодействие с моечным роботом                                    |
| mbSerialClient | Обеспечивает работу протокола modbus                                |
| orderDisplay   | Отображение данных на дисплее очереди                               |
| pyutils        | Дополнительные утилиты, необходимые для работы проекта              |
| rplclib        | Взаимодействие с оборудованием ПЛК и его модулями                   |
| scancodeReader | Взаимодействие с оборудованием считывателя QR кодов                 |
| SMSGate        | Отправка СМС, для работы с клиентскими картами                      |

В корневой директории проекта содержится файл `.gitmodules`, содержащий список всех подмодулей, а
также URL, по которому доступен каждый из них. Ниже представлен пример того, как описан подмодуль
atol в файле `.gitmodules`:

```
[submodule "atol"]
path = atol
url = git@bitbucket.org:robodinamika/atol.git
branch = master
```

Для того, чтобы инициализировать подмодули, необходимо добавить сгенерированный ранее публичный ключ
в настройках репозитория каждого из подмодулей.

Далее, необходимо убедиться, что в файлах `.gitmodules`, `.git/config`,
`.git/modules/<module>/config` и `./<module>/.gitmodules` URL каждого из подмодулей указан с
использованием SSH (т.е. начинается с `git@bitbucket.org:robodinamika/`). После проверки всех URL,
выполнить следующую команду, находясь в коревой директории проекта:

`
git submodule update --init --recursive
`

Обратите внимание, что т.к. перед выполнением команды `git` для обновления подмодулей, их
директории были пустыми. Файлы с конфигурациями `.git/modules/<module>/config` и
`./<module>/.gitmodules` будут созданы после обновления подмодулей. Соответственно, команду
`git submodule update` придется выполнить несколько раз, предварительно проверив URL каждого
подмодуля.

# Установка дополнительных Python библиотек

Перед установкой python библиотек необходимо установить их системные зависимости:

`
sudo apt install build-essential libcap-dev python-dev python-pyqt5 python-pyqt5.qtwebkit
`

Затем, с помощью pip установить python библиотеки:

`
pip install wkhtmltopdf pdfkit jinja2 configparser netifaces peewee python-crontab qrcode pyserial
`

`
pip install APScheduler astral mysql-connector-python pymysql sortedcontainers pymodbus python-prctl
`

# Настройка базы данных MariaDB

Для запуска проекта на рабочем компьютере, необходимо создать базу данных, и заполнить ее. В проекте
используется СУБД MariaDB, поэтому для начала нужно установить MariaDB Server:

`
sudo apt install mariadb-server
`

После установки MariaDB, необходимо выполнить скрипт безопасности. Он изменяет некоторые настройки
по умолчанию на более безопасные, например, удалённый вход для пользователей root и пользователи,
созданные по умолчанию. В старых версиях MariaDB вам было необходимо также инициализировать
директорию данных вручную, теперь это делается автоматически.

Выполните скрипт безопасности командой:

`
sudo mysql_secure_installation
`

В результате выполнения этого скрипта вам будет предложено внести изменения в настройки безопасности
вашей MariaDB. Сначала вам будет предложено установить плагин валидации паролей
`Validate Password Plugin`, который позволяет тестировать надёжность паролей MariaDB. Далее вам
предложат задать пароль для пользователя `root` вашей установки MariaDB. Выберите надёжный пароль и
введите его два раза.

Далее вы можете выбирать `Y` и нажимать `ENTER` для всех последующих вопросов. При этом будут
удалены некоторые анонимные пользователи и тестовые базы данных, будет отключена возможность
удалённого входа для root пользователей, после чего все внесённые изменения будут применены к вашей
установке MariaDB.

После установки и конфигурирования MariaDB, необходимо создать нового пользователя и задать ему
привилегии. Для этого, необходимо авторизоваться в MariaDB от имени `root` пользователя и выполнить
следующие команды:

`CREATE USER 'creator_database'@'localhost' IDENTIFIED BY '86nVbdFLtB';`

`GRANT ALL PRIVILEGES ON *.* TO 'creator_database'@'localhost';`

`FLUSH PRIVILEGES;`

После создания пользователя, необходимо выйти из СУБД, и заполнить базу данных тестовыми данными.
Для этого необходимо перейти в директорию, в которой находится дамп одной из БД, и выполнить:

`
mysql -u creator_database --default-character-set=utf8 < data_storage_wash.dump.sql
`

# Заключение

Основной процесс инициализации проекта завершен. Для запуска проекта необходимо создать config файл
с данными для подключения к БД, а также директорию, в которую будут сохраняться log файлы, для этого
необходимо перейти в корневую директорию проекта и выполнить`mkdir logs`, а затем создать файл 
`config.conf` со следующим содержимым:

```
[Database]
database_host = 127.0.0.1
database_user = creator_database
database_password = 86nVbdFLtB
database_database = data_storage_wash
```
